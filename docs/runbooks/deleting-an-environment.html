<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Deleting an environment (AWS account) - MoJ Modernisation Platform</title>

    <link href="../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://user-guide.modernisation-platform.service.justice.gov.uk/runbooks/deleting-an-environment.html">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="user-guide.modernisation-platform.service.justice.gov.uk" />
      <meta name="twitter:image" content="https://user-guide.modernisation-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="Deleting an environment (AWS account) - MoJ Modernisation Platform" />
      <meta name="twitter:url" content="https://user-guide.modernisation-platform.service.justice.gov.uk/runbooks/deleting-an-environment.html" />

      <meta property="og:image" content="https://user-guide.modernisation-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="MoJ Modernisation Platform" />
      <meta property="og:title" content="Deleting an environment (AWS account)" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://user-guide.modernisation-platform.service.justice.gov.uk/runbooks/deleting-an-environment.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          MoJ Modernisation Platform
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide menu">Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/modernisation-platform">Home</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/ministryofjustice/modernisation-platform">GitHub</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://mojdt.slack.com/archives/C01A7QK5VM1">Slack</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="../">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://user-guide.modernisation-platform.service.justice.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#deleting-an-environment-aws-account"><span>Deleting an environment (AWS account)</span></a>
    <ul>
      <li>
        <a href="#getting-the-root-iam-user-39-s-email-address"><span>Getting the root IAM user’s email address</span></a>
      </li>
      <li>
        <a href="#removing-the-aws-account-from-modernisation-platform-management"><span>Removing the AWS account from Modernisation Platform management</span></a>
      </li>
      <li>
        <a href="#removing-the-environment-definition"><span>Removing the environment definition</span></a>
      </li>
      <li>
        <a href="#find-and-delete-the-terraform-workspaces-for-the-environment"><span>Find and delete the Terraform workspaces for the environment</span></a>
      </li>
      <li>
        <a href="#move-the-account-to-the-root-organizational-unit"><span>Move the account to the root organizational unit</span></a>
      </li>
      <li>
        <a href="#delete-the-actual-aws-account"><span>Delete the actual AWS account</span></a>
      </li>
      <li>
        <a href="#move-the-account-to-the-closed-accounts-organizational-unit"><span>Move the account to the closed accounts organizational unit</span></a>
      </li>
      <li>
        <a href="#merge-in-your-file-changes"><span>Merge in your file changes</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="deleting-an-environment-aws-account">Deleting an environment (AWS account)</h1>

<blockquote>
<p>Note: This process is cannot be undone. All resources in an AWS account will be deleted.</p>
</blockquote>
<p>In the Modernisation Platform, we run a pipeline to create AWS accounts using the <code>aws_organizations_account</code> Terraform resource.</p>
<p>The <code>aws_organizations_account</code> cannot, and does not, delete AWS accounts if removed from the configuration. It attempts to move the AWS account from AWS Organizations to a standalone account, which should fail.</p>
<p>Therefore, there are a few things to do to delete an environment, in this order:</p>

<ol>
<li>Get the AWS accounts root IAM user&rsquo;s email address</li>
<li>Remove the environment definition from <code>environments/*.json</code></li>
<li>Remove the AWS account from Modernisation Platform management</li>
<li>Delete the <code>terraform workspace</code> wherever it appears</li>
<li>Delete the actual AWS account</li>
</ol>
<h2 id="getting-the-root-iam-user-39-s-email-address">Getting the root IAM user&rsquo;s email address</h2>
<p>You need the root IAM user&rsquo;s email address to delete the AWS account in the last step, so note it down.</p>
<p>You can get this from the SSO log on page if you have access to the account via SSO, if not it can be found in the Terraform state.</p>
<p>To do this, <code>cd</code> into <code>terraform environments</code> and find the resource in the state:</p>

<ul>
<li><code>cd terraform/environments</code></li>
<li><code>terraform state list</code></li>
</ul>
<p>To find the email address, run:</p>

<ul>
<li><code>terraform state show &lt;resource reference&gt;</code></li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span><span class="nb">cd </span>terraform/environments
<span class="nv">$ </span>terraform state list
<span class="nv">$ </span>terraform state show <span class="s1">'module.environments.aws_organizations_account.accounts["core-vpc-non-live-data"]'</span>

resource <span class="s2">"aws_organizations_account"</span> <span class="s2">"accounts"</span> <span class="o">{</span>
    ...
    email                      <span class="o">=</span> <span class="s2">"..."</span> &lt;- This will be the email address <span class="k">for </span>the root IAM user
    ...
    tags                       <span class="o">=</span> <span class="o">{</span>
        <span class="s2">"application"</span>      <span class="o">=</span> <span class="s2">"modernisation-platform"</span>
        <span class="s2">"business-unit"</span>    <span class="o">=</span> <span class="s2">"Platforms"</span>
        <span class="s2">"environment-name"</span> <span class="o">=</span> <span class="s2">"production"</span>
        <span class="s2">"is-production"</span>    <span class="o">=</span> <span class="s2">"true"</span>
        <span class="s2">"owner"</span>            <span class="o">=</span> <span class="s2">"Modernisation Platform: modernisation-platform@digital.justice.gov.uk"</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="removing-the-aws-account-from-modernisation-platform-management">Removing the AWS account from Modernisation Platform management</h2>
<p>You need to remove the resource from the Terraform state where it gets created so Terraform no longer has knowledge of it. You don&rsquo;t need to remove the organisational unit, as Terraform will remove those if they&rsquo;re not used by anything else.</p>
<p>To do this, <code>cd</code> into <code>terraform environments</code> and find the resource in the state:</p>

<ul>
<li><code>cd terraform/environments</code></li>
<li><code>terraform state list</code></li>
</ul>
<p>To remove it, run:</p>

<ul>
<li><code>terraform state rm &lt;resource reference&gt;</code></li>
</ul>
<p>For example, to remove the environment for <code>core-vpc-non-live-data</code>:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span><span class="nb">cd </span>terraform/environments
<span class="nv">$ </span>terraform state list
...
module.environments.aws_organizations_account.accounts[<span class="s2">"core-logging-production"</span><span class="o">]</span>
module.environments.aws_organizations_account.accounts[<span class="s2">"core-network-services-production"</span><span class="o">]</span>
module.environments.aws_organizations_account.accounts[<span class="s2">"core-sandbox-dev"</span><span class="o">]</span>
module.environments.aws_organizations_account.accounts[<span class="s2">"core-security-production"</span><span class="o">]</span>
module.environments.aws_organizations_account.accounts[<span class="s2">"core-shared-services-production"</span><span class="o">]</span>
module.environments.aws_organizations_account.accounts[<span class="s2">"core-vpc-non-live-data"</span><span class="o">]</span>
module.environments.aws_organizations_account.accounts[<span class="s2">"core-vpc-production"</span><span class="o">]</span>
...
<span class="nv">$ </span>terraform state <span class="nb">rm</span> <span class="s1">'module.environments.aws_organizations_account.accounts["core-vpc-non-live-data"]'</span>
Removed module.environments.aws_organizations_account.accounts[<span class="s2">"core-vpc-non-live-data"</span><span class="o">]</span>
Successfully removed 1 resource instance<span class="o">(</span>s<span class="o">)</span><span class="nb">.</span>
</code></pre></div><h2 id="removing-the-environment-definition">Removing the environment definition</h2>
<p>To ensure the account isn&rsquo;t recreated after removing it from the <code>terraform state</code>, remove it from its <code>environments/*.json</code> file.</p>
<p>For example, to remove <code>core-vpc-non-live-data</code> from the <code>core-vpc</code> set of accounts:</p>
<div class="highlight"><pre class="highlight json" tabindex="0"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"environments"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"production"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"access"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"non-live-data"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"access"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"application"</span><span class="p">:</span><span class="w"> </span><span class="s2">"modernisation-platform"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"business-unit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Platforms"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"owner"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Modernisation Platform: modernisation-platform@digital.justice.gov.uk"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><p>should become:</p>
<div class="highlight"><pre class="highlight json" tabindex="0"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"environments"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"production"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"access"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"application"</span><span class="p">:</span><span class="w"> </span><span class="s2">"modernisation-platform"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"business-unit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Platforms"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"owner"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Modernisation Platform: modernisation-platform@digital.justice.gov.uk"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><p>Update the <a href="https://github.com/ministryofjustice/modernisation-platform/tree/main/policies">OPA polices</a> to remove references to the environment.</p>
<p>Before merging in these changes, complete the rest of the steps in this document.</p>
<h2 id="find-and-delete-the-terraform-workspaces-for-the-environment">Find and delete the Terraform workspaces for the environment</h2>
<p>Run <code>find-terraform-workspaces.sh &lt;workspace name&gt;</code> to quickly return where workspaces for an AWS account exist:</p>
<p>This should be run from the modernisation platform root directory, using appropriate credetials (eg AWS Vault)</p>
<p>Note, whilst this script will find all of the workspaces, it will take a while to run, currently most accounts will only have workspaces in the following locations:</p>
<p><code>modernisation-platform/terraform/environments/bootstrap/delegate-access</code></p>
<p><code>modernisation-platform/terraform/environments/bootstrap/secure-baselines</code></p>
<p><code>modernisation-platform/terraform/environments/bootstrap/single-sign-on</code></p>
<p><code>modernisation-platform/terraform/environments/&lt;application-name&gt;</code></p>
<p>For the following workspaces, switch to the workspace and run a <code>terraform destroy</code> to ensure any resources such as DNS entries created in shared accounts are deleted and not orphaned.</p>
<p><code>modernisation-platform-environments/terraform/environments/&lt;application-name&gt;</code></p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span>aws-vault <span class="nb">exec </span>modernisation-platform <span class="nt">--</span> .scripts/internal/find-terraform-workspace.sh core-vpc-non-live-data
Starting a <span class="sb">`</span>terraform workspace<span class="sb">`</span> search from ./modernisation-platform

Searching <span class="k">for </span>Terraform workspaces <span class="k">in</span> ./terraform/environments

Workspace <span class="s2">"core-vpc-non-live-data"</span> doesn<span class="s1">'t exist.

You can create this workspace with the "new" subcommand.

Finished searching for Terraform workspaces in ./terraform/environments

...

Searching for Terraform workspaces in ./terraform/environments/bootstrap/delegate-access
Switched to workspace "default".
Switched to workspace "core-vpc-non-live-data".

Finished searching for Terraform workspaces in ./terraform/environments/bootstrap/delegate-access


Searching for Terraform workspaces in ./terraform/environments/bootstrap/secure-baselines
Switched to workspace "default".
Switched to workspace "core-vpc-non-live-data".

Finished searching for Terraform workspaces in ./terraform/environments/bootstrap/secure-baselines


Searching for Terraform workspaces in ./terraform/environments/bootstrap/single-sign-on
Switched to workspace "default".
Switched to workspace "core-vpc-non-live-data".

Finished searching for Terraform workspaces in ./terraform/environments/bootstrap/single-sign-on

...

Searching for Terraform workspaces in ./terraform/environments/core-vpc
Switched to workspace "default".
Switched to workspace "core-vpc-non-live-data".

Finished searching for Terraform workspaces in ./terraform/environments/core-vpc

...
</span></code></pre></div><p>If a workspace doesn&rsquo;t exist by that name, this script will return:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>Searching <span class="k">for </span>Terraform workspaces <span class="k">in</span> ./terraform/modernisation-platform-account

Workspace <span class="s2">"core-vpc-non-live-data"</span> doesn<span class="s1">'t exist.

You can create this workspace with the "new" subcommand.

Finished searching for Terraform workspaces in ./terraform/modernisation-platform-account
</span></code></pre></div><p>If a workspace does exist, this script will return:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>Searching <span class="k">for </span>Terraform workspaces <span class="k">in</span> ./terraform/environments/bootstrap/delegate-access
Switched to workspace <span class="s2">"default"</span><span class="nb">.</span>
Switched to workspace <span class="s2">"core-vpc-non-live-data"</span><span class="nb">.</span>

Finished searching <span class="k">for </span>Terraform workspaces <span class="k">in</span> ./terraform/environments/bootstrap/delegate-access
</code></pre></div><p>You need to go through all of the directories where the workspace appears and run:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>terraform workspace delete <span class="nt">-force</span> core-vpc-non-live-data
</code></pre></div>
<blockquote>
<p>This will not delete the resources that are set up by the Terraform configuration. It will only delete the Terraform reference to the workspace. You will need to delete the AWS account properly.</p>
</blockquote>
<p>If you delete the last environment and there are no more environments for the application, you should delete all of the environment files in the following folders:</p>
<p><code>modernisation-platform/terraform/environments/&lt;application-name&gt;</code></p>
<p><code>modernisation-platform-environments/terraform/environments/&lt;application-name&gt;</code></p>
<p><code>modernisation-platform-environments/.github/workflows/&lt;application-name&gt;</code></p>
<p>After following the above steps, you need to move the account to the closed accounts OU before deleting the actual AWS account that the environment was linked to.</p>
<h2 id="move-the-account-to-the-root-organizational-unit">Move the account to the root organizational unit</h2>

<blockquote>
<p>Note that a user with root account permissions will need to do this.</p>
</blockquote>
<p>This is to move the account out of an organizational unit where there is an SCP preventing any actions by the root user.</p>
<p>Log into the AWS Console and navigate to AWS Oraganizations, find the account and move it to the <code>root</code> OU.</p>
<p>Now the AWS account can be deleted.</p>
<h2 id="delete-the-actual-aws-account">Delete the actual AWS account</h2>

<blockquote>
<p>This process cannot be undone. Proceed carefully.</p>
</blockquote>
<p>Follow the <a href="https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_accounts_close.html">AWS documentation on closing an AWS account</a>. You will need:</p>

<ul>
<li>access to the AWS account&rsquo;s root email address (<em>not</em> the AWS Organizations root account)</li>
</ul>
<h2 id="move-the-account-to-the-closed-accounts-organizational-unit">Move the account to the closed accounts organizational unit</h2>

<blockquote>
<p>Note that a user with root account permissions will need to do this.</p>
</blockquote>
<p>Log into the AWS Console and navigate to AWS Oraganizations, find the account and move it to the <code>Closed accounts</code> OU.</p>
<h2 id="merge-in-your-file-changes">Merge in your file changes</h2>
<p>Merging in your file changes will trigger Terraform to perform the remaining clean up needed.</p>

              <div data-module='page-expiry' data-last-reviewed-on="2022-09-03">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 3 March 2022.

        It needs to be reviewed again on 3 September 2022
        by the page owner <a href="https://mojdt.slack.com/messages/modernisation-platform">#modernisation-platform</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 3 September 2022
       by the page owner <a href="https://mojdt.slack.com/messages/modernisation-platform">#modernisation-platform</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/ministryofjustice/modernisation-platform/blob/main/source/runbooks/deleting-an-environment.html.md.erb">View source</a></li>
                <li><a href="https://github.com/ministryofjustice/modernisation-platform/issues/new?body=Problem+with+%27Deleting+an+environment+%28AWS+account%29%27+%28https%3A%2F%2Fuser-guide.modernisation-platform.service.justice.gov.uk%2Frunbooks%2Fdeleting-an-environment.html%29&amp;labels=bug&amp;title=Re%3A+%27Deleting+an+environment+%28AWS+account%29%27">Report problem</a></li>
                <li><a href="https://github.com/ministryofjustice/modernisation-platform">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../javascripts/application.js"></script>
  </body>
</html>
