<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Terraform - MoJ Modernisation Platform</title>

    <link href="../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://user-guide.modernisation-platform.service.justice.gov.uk/runbooks/terraform.html">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="user-guide.modernisation-platform.service.justice.gov.uk" />
      <meta name="twitter:image" content="https://user-guide.modernisation-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="Terraform - MoJ Modernisation Platform" />
      <meta name="twitter:url" content="https://user-guide.modernisation-platform.service.justice.gov.uk/runbooks/terraform.html" />

      <meta property="og:image" content="https://user-guide.modernisation-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="MoJ Modernisation Platform" />
      <meta property="og:title" content="Terraform" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://user-guide.modernisation-platform.service.justice.gov.uk/runbooks/terraform.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          MoJ Modernisation Platform
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide menu">Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/modernisation-platform">Home</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/ministryofjustice/modernisation-platform">GitHub</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://mojdt.slack.com/archives/C01A7QK5VM1">Slack</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="../">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://user-guide.modernisation-platform.service.justice.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#terraform"><span>Terraform</span></a>
    <ul>
      <li>
        <a href="#what-we-manage-in-terraform"><span>What we manage in Terraform</span></a>
        <ul>
          <li>
            <a href="#terraform-workspaces"><span>Terraform workspaces</span></a>
          </li>
          <li>
            <a href="#permissions-required-for-each-directory-in-terraform"><span>Permissions required for each directory in terraform/</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="terraform">Terraform</h1>
<h2 id="what-we-manage-in-terraform">What we manage in Terraform</h2>
<p>We currently manage the following in Terraform:</p>

<ul>
<li>GitHub resources, including teams, repositories, actions secrets, etc</li>
<li>AWS resources, such as

<ul>
<li><a href="https://github.com/ministryofjustice/modernisation-platform/tree/main/terraform/environments">setting up new environments</a></li>
<li><a href="https://github.com/ministryofjustice/modernisation-platform/tree/main/terraform/environments/bootstrap">bootstrapping environments</a>, including the secure baselines and giving access to a role from the Modernisation Platform landing zone account</li>
<li><a href="https://github.com/ministryofjustice/modernisation-platform/tree/main/terraform/environments">environment-specific infrastructure that we manage</a>, including the core accounts for the Modernisation Platform</li>
<li><a href="https://github.com/ministryofjustice/modernisation-platform/tree/main/terraform/modernisation-platform-account">the Modernisation Platform landing zone account</a>, including S3 state storage for all environments</li>
</ul></li>
<li>PagerDuty resources, including users, teams, services and schedules</li>
</ul>
<h3 id="terraform-workspaces">Terraform workspaces</h3>
<p>We make use of Terraform workspaces to create the same resources in each environment. This allows you to interpolate <code>terraform.workspace</code> to configure different values, such as Autoscaling Group limits or tags, in different environments. For example:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>resource "aws_instance" "example" {
  count = "${terraform.workspace == "production" ? 5 : 1}"

  tags = {
    environment = terraform.workspace
    is-production = "${terraform.workspace == "production" ? true : false}"
  }
}
</code></pre></div><p>When you are running Terraform, check your workspace is set correctly for where you want to deploy changes, e.g for <code>core-logging</code>:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span><span class="nb">cd </span>terraform/environments/core-logging
<span class="nv">$ </span>terraform workspace list
<span class="k">*</span> default
  core-logging-production
<span class="nv">$ </span>terraform workspace <span class="k">select </span>core-logging-production
<span class="nv">$ </span>terraform plan
</code></pre></div><p>You will likely get an error if you haven&rsquo;t changed your workspace from <code>default</code>.</p>
<h3 id="permissions-required-for-each-directory-in-terraform">Permissions required for each directory in <code>terraform/</code></h3>
<p>Terraform doesn&rsquo;t look recursively for <code>.tf</code> files, so we utilise subdirectories to keep related infrastructure together. You need different permissions to run each directory, following the directory structure:</p>

<ul>
<li><code>terraform/</code>

<ul>
<li><code>environments/</code> needs to be run with an MOJ organisational root account IAM user</li>
<li><code>bootstrap/</code> also needs to be run with an MOJ organisational root account IAM user</li>
<li>any other subdirectory (e.g. <code>bichard7/</code>, <code>core-logging/</code> can be run using an Modernisation Platform landing zone account IAM user, after <code>bootstrap/</code> has been run for that environment</li>
<li><code>github/</code> can be run using an Modernisation Platform landing zone account IAM user, and requires a <code>GITHUB_TOKEN</code> to be set as an environment variable that has permissions to create repositories</li>
<li><code>pagerduty/</code> can be run using an Modernisation Platform landing zone account IAM user, and requires a <code>pagerduty_token</code> to be passed in as a Terraform variable with permissions to the MoJ PagerDuty account</li>
<li><code>modernisation-platform-account/</code> can be run using an Modernisation Platform landing zone account IAM user</li>
</ul></li>
</ul>
<p>All of the Terraform on the platform is also run on GitHub Actions pipelines, so running locally is not required, but can be quicker for larger development tasks. Please note that running Terraform locally will need to be run using MFA, there are different ways to do this but we are using <a href="https://github.com/99designs/aws-vault">AWS Vault</a>.</p>

              <div data-module='page-expiry' data-last-reviewed-on="2022-11-13">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 13 May 2022.

        It needs to be reviewed again on 13 November 2022
        by the page owner <a href="https://mojdt.slack.com/messages/modernisation-platform">#modernisation-platform</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 13 November 2022
       by the page owner <a href="https://mojdt.slack.com/messages/modernisation-platform">#modernisation-platform</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/ministryofjustice/modernisation-platform/blob/main/source/runbooks/terraform.html.md.erb">View source</a></li>
                <li><a href="https://github.com/ministryofjustice/modernisation-platform/issues/new?body=Problem+with+%27Terraform%27+%28https%3A%2F%2Fuser-guide.modernisation-platform.service.justice.gov.uk%2Frunbooks%2Fterraform.html%29&amp;labels=bug&amp;title=Re%3A+%27Terraform%27">Report problem</a></li>
                <li><a href="https://github.com/ministryofjustice/modernisation-platform">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../javascripts/application.js"></script>
  </body>
</html>
